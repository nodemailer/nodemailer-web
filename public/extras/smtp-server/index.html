<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.92.2" />
    <meta name="description" content="Nodemailer is a module for Node.js to send emails">
<meta name="author" content="Andris Reinman">

    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <title>SMTP Server :: Nodemailer</title>

    
    <link href="/css/nucleus.css?1692086898" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1692086898" rel="stylesheet">
    <link href="/css/hybrid.css?1692086898" rel="stylesheet">
    <link href="/css/featherlight.min.css?1692086898" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1692086898" rel="stylesheet">
    <link href="/css/auto-complete.css?1692086898" rel="stylesheet">
    <link href="/css/theme.css?1692086898" rel="stylesheet">
    <link href="/css/hugo-theme.css?1692086898" rel="stylesheet">
    
      <link href="/css/theme-blue.css?1692086898" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js?1692086898"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    <style>
  #sidebar #header-wrapper {
    background-color: white;
  }
  #sidebar #header-wrapper a {
    color: #07689f;
  }

  #ads {
     
    max-width: 260px;
     
    margin: 3px auto 10px auto;
     
    font-size: 13px;
    color: #07689f;
  }

  #carbonads * {
    margin: initial;
    padding: initial;
  }
  #carbonads {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", Helvetica, Arial, sans-serif;
  }
  #carbonads {
    display: flex;
    max-width: 330px;
    background-color: hsl(0, 0%, 98%);
    box-shadow: 0 1px 4px 1px hsla(0, 0%, 0%, 0.1);
    z-index: 100;
  }
  #carbonads a {
    color: inherit;
    text-decoration: none;
  }
  #carbonads a:hover {
    color: inherit;
  }
  #carbonads span {
    position: relative;
    display: block;
    overflow: hidden;
  }
  #carbonads .carbon-wrap {
    display: flex;
  }
  #carbonads .carbon-img {
    display: block;
    margin: 0;
    line-height: 1;
  }
  #carbonads .carbon-img img {
    display: block;
  }
  #carbonads .carbon-text {
    font-size: 13px;
    padding: 10px;
    margin-bottom: 16px;
    line-height: 1.5;
    text-align: left;
  }
  #carbonads .carbon-poweredby {
    display: block;
    padding: 6px 8px;
    background: #f1f1f2;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    font-size: 8px;
    line-height: 1;
    border-top-left-radius: 3px;
    position: absolute;
    bottom: 0;
    right: 0;
  }

  #chapter p {
    text-align: left;
  }

  code {
    line-height: 1.5rem;
  }
</style>

<script defer data-domain="nodemailer.com" src="https://plausible.srv.dev/js/script.js"></script>
<script defer src="https://postalsys.com/frame.js"></script>

  </head>
  <body class="" data-url="/extras/smtp-server/">
    <nav id="sidebar" class="">
   
  <div id="header-wrapper">
    <div id="header"><a id="logo" href="https://nodemailer.com">
  <img src="/nm_logo_200x136.png" alt="Nodemailer" />
</a>
</div>
     <p>
  <a href="https://emailengine.app/?utm_source=nodemailer&amp;utm_campaign=nodemailer&amp;utm_medium=header-link">Powered by <b>EmailEngine</b></a>
</p>
 
  </div>

  <div class="highlightable">
    
    

    

    
    

    <div
      style="
        max-width: 260px;
        margin: 3px auto 16px auto;
        font-size: 13px;
        color: #407ec9;
        background-color: hsl(0, 0%, 98%);
        box-shadow: 0 1px 4px 1px hsla(0, 0%, 0%, 0.1);
      "
    >
      <a
        href="https://emailengine.app/?utm_source=nodemailer&utm_campaign=nodemailer&utm_medium=sidebar"
        style="
          display: inline-block;
          color: #407ec9;
          text-decoration: none;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', Helvetica, Arial, sans-serif;
        "
      >
        <div style="display: flex; align-items: center; gap: 5px; width: 100%; background: white" target="_blank">
          <div style="flex-basis: 50%">
            <img src="/EmailEngine_logo_vert.png" style="width: 130px" />
          </div>
          <div style="flex-basis: 50%">
            <div style="font-size: 13px; line-height: 1.5; text-align: left">Send and receive emails easily with Outlook and Gmail using OAuth2.</div>
          </div>
        </div>
      </a>
    </div>

    <ul class="topics">
             
<li
  data-nav-id="/about/"
  title="Nodemailer"
  class="dd-item
        
        
        
        "
>
  <a href="/about/">
    <b>1. </b>Nodemailer 
  </a>
   
  <ul>
               
<li data-nav-id="/about/migrate/" title="Migration" class="dd-item ">
  <a href="/about/migrate/">
    Migration 
  </a>
</li>
            
<li data-nav-id="/about/license/" title="License" class="dd-item ">
  <a href="/about/license/">
    License 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/usage/"
  title="Usage"
  class="dd-item
        
        
        
        "
>
  <a href="/usage/">
    <b>2. </b>Usage 
  </a>
   
  <ul>
               
<li data-nav-id="/usage/why-smtp/" title="SMTP? Say what?" class="dd-item ">
  <a href="/usage/why-smtp/">
    SMTP? Say what? 
  </a>
</li>
            
<li data-nav-id="/usage/using-gmail/" title="Using Gmail" class="dd-item ">
  <a href="/usage/using-gmail/">
    Using Gmail 
  </a>
</li>
            
<li data-nav-id="/usage/bulk-mail/" title="Delivering bulk mail" class="dd-item ">
  <a href="/usage/bulk-mail/">
    Delivering bulk mail 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/message/"
  title="Message configuration"
  class="dd-item
        
        
        
        "
>
  <a href="/message/">
    <b>3. </b>Message configuration 
  </a>
   
  <ul>
               
<li data-nav-id="/message/attachments/" title="Attachments" class="dd-item ">
  <a href="/message/attachments/">
    Attachments 
  </a>
</li>
            
<li data-nav-id="/message/alternatives/" title="Alternatives" class="dd-item ">
  <a href="/message/alternatives/">
    Alternatives 
  </a>
</li>
            
<li data-nav-id="/message/addresses/" title="Address object" class="dd-item ">
  <a href="/message/addresses/">
    Address object 
  </a>
</li>
            
<li data-nav-id="/message/calendar-events/" title="Calendar events" class="dd-item ">
  <a href="/message/calendar-events/">
    Calendar events 
  </a>
</li>
            
<li data-nav-id="/message/embedded-images/" title="Embedded images" class="dd-item ">
  <a href="/message/embedded-images/">
    Embedded images 
  </a>
</li>
            
<li data-nav-id="/message/list-headers/" title="List headers" class="dd-item ">
  <a href="/message/list-headers/">
    List headers 
  </a>
</li>
            
<li data-nav-id="/message/custom-headers/" title="Custom headers" class="dd-item ">
  <a href="/message/custom-headers/">
    Custom headers 
  </a>
</li>
            
<li data-nav-id="/message/custom-source/" title="Custom source" class="dd-item ">
  <a href="/message/custom-source/">
    Custom source 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/smtp/"
  title="SMTP transport"
  class="dd-item
        
        
        
        "
>
  <a href="/smtp/">
    <b>4. </b>SMTP transport 
  </a>
   
  <ul>
               
<li data-nav-id="/smtp/envelope/" title="SMTP envelope" class="dd-item ">
  <a href="/smtp/envelope/">
    SMTP envelope 
  </a>
</li>
            
<li data-nav-id="/smtp/pooled/" title="Pooled SMTP" class="dd-item ">
  <a href="/smtp/pooled/">
    Pooled SMTP 
  </a>
</li>
            
<li data-nav-id="/smtp/testing/" title="Testing SMTP" class="dd-item ">
  <a href="/smtp/testing/">
    Testing SMTP 
  </a>
</li>
            
<li data-nav-id="/smtp/oauth2/" title="OAuth2" class="dd-item ">
  <a href="/smtp/oauth2/">
    OAuth2 
  </a>
</li>
            
<li data-nav-id="/smtp/customauth/" title="Custom authentication" class="dd-item ">
  <a href="/smtp/customauth/">
    Custom authentication 
  </a>
</li>
            
<li data-nav-id="/smtp/proxies/" title="Proxy support" class="dd-item ">
  <a href="/smtp/proxies/">
    Proxy support 
  </a>
</li>
            
<li data-nav-id="/smtp/dsn/" title="Delivery status notifications" class="dd-item ">
  <a href="/smtp/dsn/">
    Delivery status notifications 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/transports/"
  title="Other transports"
  class="dd-item
        
        
        
        "
>
  <a href="/transports/">
    <b>5. </b>Other transports 
  </a>
   
  <ul>
               
<li data-nav-id="/transports/sendmail/" title="Sendmail transport" class="dd-item ">
  <a href="/transports/sendmail/">
    Sendmail transport 
  </a>
</li>
            
<li data-nav-id="/transports/ses/" title="SES transport" class="dd-item ">
  <a href="/transports/ses/">
    SES transport 
  </a>
</li>
            
<li data-nav-id="/transports/stream/" title="Stream transport" class="dd-item ">
  <a href="/transports/stream/">
    Stream transport 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/plugins/"
  title="Plugins"
  class="dd-item
        
        
        
        "
>
  <a href="/plugins/">
    <b>6. </b>Plugins 
  </a>
   
  <ul>
               
<li data-nav-id="/plugins/create/" title="Create plugins" class="dd-item ">
  <a href="/plugins/create/">
    Create plugins 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/dkim/"
  title="DKIM"
  class="dd-item
        
        
        
        "
>
  <a href="/dkim/">
    <b>7. </b>DKIM 
  </a>
   
</li>
         
<li
  data-nav-id="/extras/"
  title="Extra modules"
  class="dd-item
        parent
        
        
        "
>
  <a href="/extras/">
    <b>8. </b>Extra modules 
  </a>
   
  <ul>
               
<li data-nav-id="/extras/smtp-server/" title="SMTP Server" class="dd-item active">
  <a href="/extras/smtp-server/">
    SMTP Server 
  </a>
</li>
            
<li data-nav-id="/extras/smtp-connection/" title="SMTP Connection" class="dd-item ">
  <a href="/extras/smtp-connection/">
    SMTP Connection 
  </a>
</li>
            
<li data-nav-id="/extras/mailparser/" title="Mailparser" class="dd-item ">
  <a href="/extras/mailparser/">
    Mailparser 
  </a>
</li>
            
<li data-nav-id="/extras/mailcomposer/" title="Mailcomposer" class="dd-item ">
  <a href="/extras/mailcomposer/">
    Mailcomposer 
  </a>
</li>
            
<li data-nav-id="/extras/daemons/" title="Node.js daemons" class="dd-item ">
  <a href="/extras/daemons/">
    Node.js daemons 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/app/"
  title="NodemailerApp"
  class="dd-item
        
        
        
        "
>
  <a href="/app/">
    <b>9. </b>NodemailerApp 
  </a>
   
</li>
    
    </ul>

      
    <section id="footer"><div style="text-align: center; margin-bottom:10px;">
    <form
        action="https://www.paypal.com/cgi-bin/webscr"
        method="post"
        target="_top"
    >
        <input type="hidden" name="cmd" value="_s-xclick" />
        <input type="hidden" name="hosted_button_id" value="DB26KWR2BQX5W" />
        <input
            type="image"
            src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif"
            border="0"
            name="submit"
            alt="PayPal - The safer, easier way to pay online!"
            style="display: inline"
        />
        <img
            alt=""
            border="0"
            src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif"
            width="1"
            height="1"
        />
    </form>
</div>
</section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Nodemailer</a> > <a href='/extras/'>Extra modules</a> > SMTP Server
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#usage">Usage</a>
      <ul>
        <li></li>
        <li><a href="#tls-and-startls-notice">TLS and STARTLS notice</a></li>
        <li><a href="#start-the-server-instance">Start the server instance</a></li>
      </ul>
    </li>
    <li><a href="#handling-errors">Handling errors</a></li>
    <li><a href="#handling-authentication">Handling Authentication</a>
      <ul>
        <li><a href="#examples">Examples</a></li>
      </ul>
    </li>
    <li><a href="#validating-client-connection">Validating client connection</a></li>
    <li><a href="#validating-tls-information">Validating TLS information</a></li>
    <li><a href="#validating-sender-addresses">Validating sender addresses</a></li>
    <li><a href="#validating-recipient-addresses">Validating recipient addresses</a></li>
    <li><a href="#processing-incoming-message">Processing incoming message</a></li>
    <li><a href="#using-size-extension">Using SIZE extension</a></li>
    <li><a href="#using-lmtp">Using LMTP</a></li>
    <li><a href="#session-object">Session object</a></li>
    <li><a href="#address-object">Address object</a></li>
    <li><a href="#supported-smtp-commands">Supported SMTP commands</a>
      <ul>
        <li><a href="#commands">Commands</a></li>
        <li><a href="#extensions">Extensions</a></li>
      </ul>
    </li>
    <li><a href="#license">License</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>SMTP Server</h1>
          

        


<p>Create SMTP and LMTP server instances on the fly. This is not a full-blown server application like <a href="https://haraka.github.io/">Haraka</a> but an easy way to add custom SMTP listeners to your app. This module is the successor for the server part of the (now deprecated) SMTP module <a href="https://www.npmjs.com/package/simplesmtp">simplesmtp</a>. For matching SMTP client see <a href="/extras/smtp-connection/">smtp-connection</a>.</p>
<div class="notices note" >
This module does not make any email deliveries by itself. _smtp-server_ allows you to listen on ports 25/24/465/587 etc. using SMTP or LMTP protocol and that's it. Your own application is responsible of accepting and delivering the message to destination.
</div>
<h2 id="usage">Usage</h2>
<h4 id="step-1-install-with-npm">Step 1. Install with npm</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">npm install smtp-server --save
</code></pre></div><h4 id="step-2-require-in-your-script">Step 2. Require in your script</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">SMTPServer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;smtp-server&#34;</span>).<span style="color:#a6e22e">SMTPServer</span>;
</code></pre></div><h4 id="step-3-create-smtpserver-instance">Step 3. Create SMTPServer instance</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>(<span style="color:#a6e22e">options</span>);
</code></pre></div><p>Where</p>
<ul>
<li><strong>options</strong> defines the behavior of the server
<ul>
<li><strong>options.secure</strong> if <em>true</em>, the connection will use TLS. The default is <em>false</em>. If the server doesn&rsquo;t start in TLS mode, it is still possible to upgrade clear text socket to TLS socket with the STARTTLS command (unless you disable support for it). If secure is <em>true</em>, <a href="http://nodejs.org/api/tls.html#tls_tls_createserver_options_secureconnectionlistener">additional tls options for tls.createServer</a> can be added directly onto this options object.</li>
<li><strong>options.name</strong> optional hostname of the server, used for identifying to the client (defaults to <em>os.hostname()</em>)</li>
<li><strong>options.banner</strong> optional greeting message. This message is appended to the default ESMTP response.</li>
<li><strong>options.size</strong> optional maximum allowed message size in bytes, see details <a href="#using-size-extension">here</a></li>
<li><strong>options.hideSize</strong> if set to true then does not expose the max allowed size to the client but keeps size related values like <em>stream.sizeExceeded</em></li>
<li><strong>options.authMethods</strong> optional array of allowed authentication methods, defaults to <em>[&lsquo;PLAIN&rsquo;, &lsquo;LOGIN&rsquo;]</em>. Only the methods listed in this array are allowed, so if you set it to <em>[&lsquo;XOAUTH2&rsquo;]</em> then PLAIN and LOGIN are not available. Use <em>[&lsquo;PLAIN&rsquo;, &lsquo;LOGIN&rsquo;, &lsquo;XOAUTH2&rsquo;]</em> to allow all three. Authentication is only allowed in secure mode (either the server is started with <em>secure:true</em> option or STARTTLS command is used)</li>
<li><strong>options.authOptional</strong> allow authentication, but do not require it</li>
<li><strong>options.disabledCommands</strong> optional array of disabled commands (see all supported commands <a href="#commands">here</a>). For example if you want to disable authentication, use <em>[&lsquo;AUTH&rsquo;]</em> as this value. If you want to allow authentication in clear text, set it to <em>[&lsquo;STARTTLS&rsquo;]</em>.</li>
<li><strong>options.hideSTARTTLS</strong> optional boolean, if set to true then allow using STARTTLS but do not advertise or require it. It only makes sense when creating integration test servers for testing the scenario where you want to try STARTTLS even when it is not advertised</li>
<li><strong>options.hidePIPELINING</strong> optional boolean, if set to true then does not show PIPELINING in feature list</li>
<li><strong>options.hide8BITMIME</strong> optional boolean, if set to true then does not show 8BITMIME in features list</li>
<li><strong>options.hideSMTPUTF8</strong> optional boolean, if set to true then does not show SMTPUTF8 in features list</li>
<li><strong>options.allowInsecureAuth</strong> optional boolean, if set to true allows authentication even if connection is not secured first</li>
<li><strong>options.disableReverseLookup</strong> optional boolean, if set to true then does not try to reverse resolve client hostname</li>
<li><strong>options.sniOptions</strong> optional <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map">Map</a> or an object of TLS options for SNI where servername is the key. Overrided by SNICallback.</li>
<li><strong>options.logger</strong> optional <a href="https://github.com/trentm/node-bunyan">bunyan</a> compatible logger instance. If set to <em>true</em> then logs to console. If value is not set or is <em>false</em> then nothing is logged</li>
<li><strong>options.maxClients</strong> sets the maximum number of concurrently connected clients, defaults to <em>Infinity</em></li>
<li><strong>options.useProxy</strong> boolean, if set to true expects to be behind a proxy that emits a <a href="http://www.haproxy.org/download/1.5/doc/proxy-protocol.txt">PROXY header</a> (version 1 only)</li>
<li><strong>options.useXClient</strong> boolean, if set to true, enables usage of <a href="http://www.postfix.org/XCLIENT_README.html">XCLIENT</a> extension to override connection properties. See <em>session.xClient</em> (Map object) for the details provided by the client</li>
<li><strong>options.useXForward</strong> boolean, if set to true, enables usage of <a href="http://www.postfix.org/XFORWARD_README.html">XFORWARD</a> extension. See <em>session.xForward</em> (Map object) for the details provided by the client</li>
<li><strong>options.lmtp</strong> boolean, if set to true use LMTP protocol instead of SMTP</li>
<li><strong>options.socketTimeout</strong> how many milliseconds of inactivity to allow before disconnecting the client (defaults to 1 minute)</li>
<li><strong>options.closeTimeout</strong> how many millisceonds to wait before disconnecting pending connections once server.close() has been called (defaults to 30 seconds)</li>
<li><strong>options.onAuth</strong> is the callback to handle authentications (see details <a href="#handling-authentication">here</a>)</li>
<li><strong>options.onConnect</strong> is the callback to handle the client connection. (see details <a href="#validating-client-connection">here</a>)</li>
<li><strong>options.onSecure</strong> is the optional callback to validate TLS information. (see details <a href="#validating-tls-information">here</a>)</li>
<li><strong>options.onMailFrom</strong> is the callback to validate MAIL FROM commands (see details <a href="#validating-sender-addresses">here</a>)</li>
<li><strong>options.onRcptTo</strong> is the callback to validate RCPT TO commands (see details <a href="#validating-recipient-addresses">here</a>)</li>
<li><strong>options.onData</strong> is the callback to handle incoming messages (see details <a href="#processing-incoming-message">here</a>)</li>
<li><strong>options.onClose</strong> is the callback that informs about closed client connection</li>
</ul>
</li>
</ul>
<p>Additionally you can use the options from <a href="http://nodejs.org/api/net.html#net_net_createserver_options_connectionlistener">net.createServer</a> and <a href="http://nodejs.org/api/tls.html#tls_tls_createserver_options_secureconnectionlistener">tls.createServer</a> (applies if <em>secure</em> is set to true)</p>
<h4 id="server-methods">Server Methods</h4>
<p>The <em>server</em> object returned from <em>new SMTPServer</em> has the following methods:</p>
<ul>
<li><strong>listen(port)</strong> - Begins listening on the given port</li>
<li><strong>close(callback)</strong> - Stops the server from accepting new connections. <em>callback</em> is invoked once all client connections are closed</li>
</ul>
<h3 id="tls-and-startls-notice">TLS and STARTLS notice</h3>
<p>If you use <em>secure:true</em> option or you do not disable STARTTLS command then you SHOULD also define the <em>key</em>, <em>cert</em> and possibly <em>ca</em> properties to use a proper certificate. If you do no specify your own certificate then a pregenerated self-signed certificate for &lsquo;localhost&rsquo; is used. Any respectful client refuses to accept such certificate.</p>
<p><strong>Example</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// This example starts a SMTP server using TLS with your own certificate and key
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">secure</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
  <span style="color:#a6e22e">key</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">readFileSync</span>(<span style="color:#e6db74">&#34;private.key&#34;</span>),
  <span style="color:#a6e22e">cert</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">readFileSync</span>(<span style="color:#e6db74">&#34;server.crt&#34;</span>),
});
<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#ae81ff">465</span>);
</code></pre></div><h3 id="start-the-server-instance">Start the server instance</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#a6e22e">port</span>[,<span style="color:#a6e22e">host</span>][,<span style="color:#a6e22e">callback</span>]);
</code></pre></div><p>Where</p>
<ul>
<li><strong>port</strong> is the port number to bound to</li>
<li><strong>host</strong> is the optional host to bound to</li>
<li><strong>callback</strong> is called once the server is bound</li>
</ul>
<h2 id="handling-errors">Handling errors</h2>
<p>Errors can be handled by setting an &lsquo;error&rsquo; event listener to the server instance</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;error&#34;</span>, (<span style="color:#a6e22e">err</span>) =&gt; {
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Error %s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">message</span>);
});
</code></pre></div><h2 id="handling-authentication">Handling Authentication</h2>
<p>Authentication calls can be handled with <em>onAuth</em> handler</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">onAuth</span>(<span style="color:#a6e22e">auth</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {},
});
</code></pre></div><p>Where</p>
<ul>
<li><strong>auth</strong> is an authentication object
<ul>
<li><strong>method</strong> indicates the authentication method used, &lsquo;PLAIN&rsquo;, &lsquo;LOGIN&rsquo; or &lsquo;XOAUTH2&rsquo;</li>
<li><strong>username</strong> is the username of the user</li>
<li><strong>password</strong> is the password if LOGIN or PLAIN was used</li>
<li><strong>accessToken</strong> is the OAuth2 bearer access token if &lsquo;XOAUTH2&rsquo; was used as the authentication method</li>
<li><strong>validatePassword</strong> is a function for validating CRAM-MD5 challenge responses. Takes the password of the user as an argument and returns <em>true</em> if the response matches the password</li>
</ul>
</li>
<li><strong>session</strong> includes information about the session like <em>remoteAddress</em> for the remote IP, see details <a href="#session-object">here</a></li>
<li><strong>callback</strong> is the function to run once the user is authenticated. Takes 2 arguments: <em>(error, response)</em>
<ul>
<li><strong>error</strong> is an error to return if authentication failed. If you want to set custom error code, set <em>responseCode</em> to the error object</li>
<li><strong>response</strong> is an object with the authentication results
<ul>
<li><strong>user</strong> can be any value - if this is set then the user is considered logged in and this value is used later with the session data to identify the user. If this value is empty, then the authentication is considered failed</li>
<li><strong>data</strong> is an object to return if XOAUTH2 authentication failed (do not set the error object in this case). This value is serialized to JSON and base64 encoded automatically, so you can just return the object</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This module supports <em>CRAM-MD5</em> but the use of it is discouraged as it requires access to unencrypted user passwords during the authentication process. You shouldn&rsquo;t store passwords unencrypted.</p>
<h3 id="examples">Examples</h3>
<h4 id="password-based-authentication">Password based authentication</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">onAuth</span>(<span style="color:#a6e22e">auth</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">auth</span>.<span style="color:#a6e22e">username</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;abc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">auth</span>.<span style="color:#a6e22e">password</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;def&#34;</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Invalid username or password&#34;</span>));
    }
    <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, { <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">123</span> }); <span style="color:#75715e">// where 123 is the user id or similar property
</span><span style="color:#75715e"></span>  },
});
</code></pre></div><h4 id="oauth2-authentication">OAuth2 authentication</h4>
<p>XOAUTH2 support needs to enabled with the <em>authMethods</em> array option as it is disabled by default.
If you support multiple authentication mechanisms, then you can check the used mechanism from the <em>method</em> property.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">authMethods</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;XOAUTH2&#34;</span>], <span style="color:#75715e">// XOAUTH2 is not enabled by default
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">onAuth</span>(<span style="color:#a6e22e">auth</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">auth</span>.<span style="color:#a6e22e">method</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;XOAUTH2&#34;</span>) {
      <span style="color:#75715e">// should never occur in this case as only XOAUTH2 is allowed
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Expecting XOAUTH2&#34;</span>));
    }
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">auth</span>.<span style="color:#a6e22e">username</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;abc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">auth</span>.<span style="color:#a6e22e">accessToken</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;def&#34;</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, {
        <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> {
          <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;401&#34;</span>,
          <span style="color:#a6e22e">schemes</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;bearer mac&#34;</span>,
          <span style="color:#a6e22e">scope</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;my_smtp_access_scope_name&#34;</span>,
        },
      });
    }
    <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, { <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">123</span> }); <span style="color:#75715e">// where 123 is the user id or similar property
</span><span style="color:#75715e"></span>  },
});
</code></pre></div><h4 id="cram-md5-authentication">CRAM-MD5 authentication</h4>
<p>CRAM-MD5 support needs to enabled with the <em>authMethods</em> array option as it is disabled by default.
If you support multiple authentication mechanisms, then you can check the used mechanism from the <em>method</em> property.</p>
<p>This authentication method does not return a password with the username but a response to a challenge. To validate the returned challenge response, the authentication object includes a method <em>validatePassword</em> that takes the actual plaintext password as an argument and returns either <em>true</em> if the password matches with the challenge response or <em>false</em> if it does not.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">authMethods</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;CRAM-MD5&#34;</span>], <span style="color:#75715e">// CRAM-MD5 is not enabled by default
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">onAuth</span>(<span style="color:#a6e22e">auth</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">auth</span>.<span style="color:#a6e22e">method</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;CRAM-MD5&#34;</span>) {
      <span style="color:#75715e">// should never occur in this case as only CRAM-MD5 is allowed
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Expecting CRAM-MD5&#34;</span>));
    }

    <span style="color:#75715e">// CRAM-MD5 does not provide a password but a challenge response
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// that can be validated against the actual password of the user
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">auth</span>.<span style="color:#a6e22e">username</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;abc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">auth</span>.<span style="color:#a6e22e">validatePassword</span>(<span style="color:#e6db74">&#34;def&#34;</span>)) {
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Invalid username or password&#34;</span>));
    }

    <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, { <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">123</span> }); <span style="color:#75715e">// where 123 is the user id or similar property
</span><span style="color:#75715e"></span>  },
});
</code></pre></div><h2 id="validating-client-connection">Validating client connection</h2>
<p>By default any client connection is allowed. If you want to check the remoteAddress or clientHostname before
any other command, you can set a handler for it with <em>onConnect</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">onConnect</span>(<span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {},
});
</code></pre></div><p>Where</p>
<ul>
<li><strong>session</strong> includes the <em>remoteAddress</em> and <em>clientHostname</em> values</li>
<li><strong>callback</strong> is the function to run after validation. If you return an error object, the connection is rejected, otherwise it is accepted</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">onConnect</span>(<span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">remoteAddress</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;No connections from localhost allowed&#34;</span>));
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(); <span style="color:#75715e">// Accept the connection
</span><span style="color:#75715e"></span>  },
});
</code></pre></div><p>If you also need to detect when a connection is closed use <em>onClose</em>. This method does not expect you to run a callback function as it is purely informational.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">onClose</span>(<span style="color:#a6e22e">session</span>) {},
});
</code></pre></div><h2 id="validating-tls-information">Validating TLS information</h2>
<p><em>onSecure</em> allows to validate TLS information for TLS and STARTTLS connections.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">onSecure</span>(<span style="color:#a6e22e">socket</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {},
});
</code></pre></div><p>Where</p>
<ul>
<li><strong>socket</strong> is the TLS socket object</li>
<li><strong>session</strong> includes the <em>servername</em> value for SNI</li>
<li><strong>callback</strong> is the function to run after validation. If you return an error object, the connection is rejected, otherwise it is accepted</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">onSecure</span>(<span style="color:#a6e22e">socket</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">servername</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;sni.example.com&#34;</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Only connections for sni.example.com are allowed&#34;</span>));
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(); <span style="color:#75715e">// Accept the connection
</span><span style="color:#75715e"></span>  },
});
</code></pre></div><h2 id="validating-sender-addresses">Validating sender addresses</h2>
<p>By default all sender addresses (as long as these are in valid email format) are allowed. If you want to check
the address before it is accepted you can set a handler for it with <em>onMailFrom</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">onMailFrom</span>(<span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {},
});
</code></pre></div><p>Where</p>
<ul>
<li><strong>address</strong> is an <a href="#address-object">address object</a> with the provided email address from <em>MAIL FROM:</em> command</li>
<li><strong>session</strong> includes the <em>envelope</em> object and <em>user</em> data if logged in, see details <a href="#session-object">here</a></li>
<li><strong>callback</strong> is the function to run after validation. If you return an error object, the address is rejected, otherwise it is accepted</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">onMailFrom</span>(<span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">address</span>.<span style="color:#a6e22e">address</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;allowed@example.com&#34;</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Only allowed@example.com is allowed to send mail&#34;</span>));
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(); <span style="color:#75715e">// Accept the address
</span><span style="color:#75715e"></span>  },
});
</code></pre></div><h2 id="validating-recipient-addresses">Validating recipient addresses</h2>
<p>By default all recipient addresses (as long as these are in valid email format) are allowed. If you want to check
the address before it is accepted you can set a handler for it with <em>onRcptTo</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">onRcptTo</span>(<span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {},
});
</code></pre></div><p>Where</p>
<ul>
<li><strong>address</strong> is an <a href="#address-object">address object</a> with the provided email address from <em>RCPT TO:</em> command</li>
<li><strong>session</strong> includes the <em>envelope</em> object and <em>user</em> data if logged in, see details <a href="#session-object">here</a></li>
<li><strong>callback</strong> is the function to run after validation. If you return an error object, the address is rejected, otherwise it is accepted</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">onRcptTo</span>(<span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">address</span>.<span style="color:#a6e22e">address</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;allowed@example.com&#34;</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Only allowed@example.com is allowed to receive mail&#34;</span>));
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(); <span style="color:#75715e">// Accept the address
</span><span style="color:#75715e"></span>  },
});
</code></pre></div><h2 id="processing-incoming-message">Processing incoming message</h2>
<p>You can get the stream for the incoming message with <em>onData</em> handler</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">onData</span>(<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {},
});
</code></pre></div><p>Where</p>
<ul>
<li><strong>stream</strong> is a readable stream for the incoming message</li>
<li><strong>session</strong> includes the <em>envelope</em> object and <em>user</em> data if logged in, see details <a href="#session-object">here</a></li>
<li><strong>callback</strong> is the on to run once the stream is ended and you have processed the outcome. If you return an error object, the message is rejected, otherwise it is accepted</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">onData</span>(<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {
    <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">stdout</span>); <span style="color:#75715e">// print message to console
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;end&#34;</span>, <span style="color:#a6e22e">callback</span>);
  },
});
</code></pre></div><p>This module does not prepend <em>Received</em> or any other header field to the streamed message. The entire message is streamed as-is with no modifications whatsoever. For compliancy you should add the Received data to the message yourself, see <a href="https://tools.ietf.org/html/rfc5321#section-4.4">rfc5321 4.4. Trace Information</a> for details.</p>
<h2 id="using-size-extension">Using SIZE extension</h2>
<p>When creating the server you can define maximum allowed message size with the <em>size</em> option, see <a href="https://tools.ietf.org/html/rfc1870">RFC1870</a> for details. This is not a strict limitation, the client is informed about the size limit but the client can still send a larger message than allowed, it is up to your application to reject or accept the oversized message. To check if the message was oversized, see <em>stream.sizeExceeded</em> property.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">size</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1024</span>, <span style="color:#75715e">// allow messages up to 1 kb
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">onRcptTo</span>(<span style="color:#a6e22e">address</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {
    <span style="color:#75715e">// do not accept messages larger than 100 bytes to specific recipients
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">expectedSize</span> <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">envelope</span>.<span style="color:#a6e22e">mailFrom</span>.<span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">SIZE</span>) <span style="color:#f92672">||</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">address</span>.<span style="color:#a6e22e">address</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;almost-full@example.com&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">expectedSize</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">100</span>) {
      <span style="color:#a6e22e">err</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Insufficient channel storage: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">address</span>.<span style="color:#a6e22e">address</span>);
      <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">responseCode</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">452</span>;
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#a6e22e">err</span>);
    }
    <span style="color:#a6e22e">callback</span>();
  },
  <span style="color:#a6e22e">onData</span>(<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {
    <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">stdout</span>); <span style="color:#75715e">// print message to console
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;end&#34;</span>, () =&gt; {
      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">err</span>;
      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">sizeExceeded</span>) {
        <span style="color:#a6e22e">err</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Message exceeds fixed maximum message size&#34;</span>);
        <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">responseCode</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">552</span>;
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#a6e22e">err</span>);
      }
      <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, <span style="color:#e6db74">&#34;Message queued as abcdef&#34;</span>);
    });
  },
});
</code></pre></div><h2 id="using-lmtp">Using LMTP</h2>
<p>If <em>lmtp</em> option is set to true when starting the server, then LMTP protocol is used instead of SMTP. The main
difference between these two is how multiple recipients are handled. In case of SMTP the message either fails or succeeds
but in LMTP the message might fail and succeed individually for every recipient.</p>
<p>If your LMTP server application does not distinguish between different recipients then you do not need to care about it.
On the other hand if you want to report results separately for every recipient you can do this by providing an array
of responses instead of a single error or success message. The array must contain responses in the same order as in the
envelope rcptTo array.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SMTPServer</span>({
  <span style="color:#a6e22e">lmtp</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
  <span style="color:#a6e22e">onData</span>(<span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">callback</span>) {
    <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">stdout</span>); <span style="color:#75715e">// print message to console
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;end&#34;</span>, () =&gt; {
      <span style="color:#75715e">// reject every other recipient
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">envelope</span>.<span style="color:#a6e22e">rcptTo</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">rcpt</span>, <span style="color:#a6e22e">i</span>) =&gt; {
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">i</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span>) {
          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;&lt;&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rcpt</span>.<span style="color:#a6e22e">address</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&gt; Not accepted&#34;</span>);
        } <span style="color:#66d9ef">else</span> {
          <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&lt;&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rcpt</span>.<span style="color:#a6e22e">address</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&gt; Accepted&#34;</span>;
        }
      });
      <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, <span style="color:#a6e22e">response</span>);
    });
  },
});
</code></pre></div><p>If you provide a single error by invoking <em>callback(err)</em> or single success message <em>callback(null, &lsquo;OK&rsquo;)</em> like when dealing with SMTP then every recipient gets the same response.</p>
<h2 id="session-object">Session object</h2>
<p>Session object that is passed to the handler functions includes the following properties</p>
<ul>
<li><strong>id</strong> random string identificator generated when the client connected</li>
<li><strong>remoteAddress</strong> the IP address for the connected client</li>
<li><strong>clientHostname</strong> reverse resolved hostname for <em>remoteAddress</em></li>
<li><strong>openingCommand</strong> the opening SMTP command (HELO/EHLO/LHLO)</li>
<li><strong>hostNameAppearsAs</strong> hostname the client provided with HELO/EHLO call</li>
<li><strong>envelope</strong> includes envelope data
<ul>
<li><strong>mailFrom</strong> includes an address object or is set to false</li>
<li><strong>rcptTo</strong> includes an array of address objects</li>
</ul>
</li>
<li><strong>user</strong> includes the <em>user</em> value returned with the authentication handler</li>
<li><strong>transaction</strong> number of the current transaction. 1 is for the first message, 2 is for the 2nd message etc.</li>
<li><strong>transmissionType</strong> indicates the current protocol type for the received header (SMTP, ESMTP, ESMTPA etc.)</li>
</ul>
<h2 id="address-object">Address object</h2>
<p>Address object in the <em>mailFrom</em> and <em>rcptTo</em> values include the following properties</p>
<ul>
<li><strong>address</strong> is the address provided with the MAIL FROM or RCPT TO command</li>
<li><strong>args</strong> is an object with additional arguments (all key names are uppercase)</li>
</ul>
<p>For example if the client runs the following commands:</p>
<pre><code>C: MAIL FROM:&lt;sender@example.com&gt; SIZE=12345 RET=HDRS
C: RCPT TO:&lt;recipient@example.com&gt; NOTIFY=NEVER
</code></pre>
<p>then the envelope object is going go look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;mailFrom&#34;</span>: {
    <span style="color:#f92672">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;sender@example.com&#34;</span>,
    <span style="color:#f92672">&#34;args&#34;</span>: {
      <span style="color:#f92672">&#34;SIZE&#34;</span>: <span style="color:#e6db74">&#34;12345&#34;</span>,
      <span style="color:#f92672">&#34;RET&#34;</span>: <span style="color:#e6db74">&#34;HDRS&#34;</span>
    }
  },
  <span style="color:#f92672">&#34;rcptTo&#34;</span>: [
    {
      <span style="color:#f92672">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;receiver@example.com&#34;</span>,
      <span style="color:#f92672">&#34;args&#34;</span>: {
        <span style="color:#f92672">&#34;NOTIFY&#34;</span>: <span style="color:#e6db74">&#34;NEVER&#34;</span>
      }
    }
  ]
}
</code></pre></div><h2 id="supported-smtp-commands">Supported SMTP commands</h2>
<h3 id="commands">Commands</h3>
<ul>
<li><strong>AUTH LOGIN</strong></li>
<li><strong>AUTH PLAIN</strong></li>
<li><strong>AUTH XOAUTH2</strong> not enabled by default, add to <em>authMethods:[&lsquo;XOAUTH2&rsquo;]</em> to enable</li>
<li><strong>EHLO</strong></li>
<li><strong>DATA</strong></li>
<li><strong>HELO</strong></li>
<li><strong>HELP</strong> returns URL to RFC5321</li>
<li><strong>MAIL</strong></li>
<li><strong>NOOP</strong></li>
<li><strong>QUIT</strong></li>
<li><strong>RCPT</strong></li>
<li><strong>RSET</strong> clears session info but does not renegotiate TLS session</li>
<li><strong>STARTTLS</strong></li>
<li><strong>VRFY</strong> always returns positive 252 response</li>
</ul>
<h3 id="extensions">Extensions</h3>
<ul>
<li><strong>PIPELINING</strong></li>
<li><strong>8BITMIME</strong> allows 8bit message content</li>
<li><strong>SMTPUTF8</strong> accepts unicode e-mail addresses like <em>@.</em></li>
<li><strong>SIZE</strong> limits maximum message size</li>
</ul>
<p>Most notably, the <strong>ENHANCEDSTATUSCODES</strong> extension is not supported, all response codes use the standard three digit format and nothing else. I might change this in the future if I have time to revisit all responses and find the appropriate response codes.</p>
<p><strong>CHUNKING</strong> is also missing. I might add support for it in the future but not at this moment since DATA already accepts a stream and CHUNKING is not supported everywhere.</p>
<h2 id="license">License</h2>
<p><strong>MIT</strong></p>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/extras/" title="Extra modules"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/extras/smtp-connection/" title="SMTP Connection" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1692086898"></script>
    <script src="/js/perfect-scrollbar.min.js?1692086898"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1692086898"></script>
    <script src="/js/jquery.sticky.js?1692086898"></script>
    <script src="/js/featherlight.min.js?1692086898"></script>
    <script src="/js/html5shiv-printshiv.min.js?1692086898"></script>
    <script src="/js/highlight.pack.js?1692086898"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1692086898"></script>
    <script src="/js/learn.js?1692086898"></script>
    <script src="/js/hugo-learn.js?1692086898"></script>

    <link href="/mermaid/mermaid.css?1692086898" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1692086898"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

