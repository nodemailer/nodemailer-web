<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.92.2" />
    <meta name="description" content="Nodemailer is a module for Node.js to send emails">
<meta name="author" content="Andris Reinman">

    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <title>OAuth2 :: Nodemailer</title>

    
    <link href="/css/nucleus.css?1681891445" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1681891445" rel="stylesheet">
    <link href="/css/hybrid.css?1681891445" rel="stylesheet">
    <link href="/css/featherlight.min.css?1681891445" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1681891445" rel="stylesheet">
    <link href="/css/auto-complete.css?1681891445" rel="stylesheet">
    <link href="/css/theme.css?1681891445" rel="stylesheet">
    <link href="/css/hugo-theme.css?1681891445" rel="stylesheet">
    
      <link href="/css/theme-blue.css?1681891445" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js?1681891445"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    <style>
  #sidebar #header-wrapper {
    background-color: white;
  }
  #sidebar #header-wrapper a {
    color: #07689f;
  }

  #ads {
     
    max-width: 260px;
     
    margin: 3px auto 10px auto;
     
    font-size: 13px;
    color: #07689f;
  }

  #carbonads * {
    margin: initial;
    padding: initial;
  }
  #carbonads {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", Helvetica, Arial, sans-serif;
  }
  #carbonads {
    display: flex;
    max-width: 330px;
    background-color: hsl(0, 0%, 98%);
    box-shadow: 0 1px 4px 1px hsla(0, 0%, 0%, 0.1);
    z-index: 100;
  }
  #carbonads a {
    color: inherit;
    text-decoration: none;
  }
  #carbonads a:hover {
    color: inherit;
  }
  #carbonads span {
    position: relative;
    display: block;
    overflow: hidden;
  }
  #carbonads .carbon-wrap {
    display: flex;
  }
  #carbonads .carbon-img {
    display: block;
    margin: 0;
    line-height: 1;
  }
  #carbonads .carbon-img img {
    display: block;
  }
  #carbonads .carbon-text {
    font-size: 13px;
    padding: 10px;
    margin-bottom: 16px;
    line-height: 1.5;
    text-align: left;
  }
  #carbonads .carbon-poweredby {
    display: block;
    padding: 6px 8px;
    background: #f1f1f2;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    font-size: 8px;
    line-height: 1;
    border-top-left-radius: 3px;
    position: absolute;
    bottom: 0;
    right: 0;
  }

  #chapter p {
    text-align: left;
  }

  code {
    line-height: 1.5rem;
  }
</style>

<script defer data-domain="nodemailer.com" src="https://plausible.srv.dev/js/script.js"></script>
<script defer src="https://postalsys.com/frame.js"></script>

  </head>
  <body class="" data-url="/smtp/oauth2/">
    <nav id="sidebar" class="">
   
  <div id="header-wrapper">
    <div id="header"><a id="logo" href="https://nodemailer.com">
  <img src="/nm_logo_200x136.png" alt="Nodemailer" />
</a>
</div>
     <p>
  <a href="https://emailengine.app/?utm_source=nodemailer&amp;utm_campaign=nodemailer&amp;utm_medium=header-link">Powered by <b>EmailEngine</b></a>
</p>
 
  </div>

  <div class="highlightable">
    
    

    

    
    

    <div
      style="
        max-width: 260px;
        margin: 3px auto 16px auto;
        font-size: 13px;
        color: #407ec9;
        background-color: hsl(0, 0%, 98%);
        box-shadow: 0 1px 4px 1px hsla(0, 0%, 0%, 0.1);
      "
    >
      <a
        href="https://emailengine.app/?utm_source=nodemailer&utm_campaign=nodemailer&utm_medium=sidebar"
        style="
          display: inline-block;
          color: #407ec9;
          text-decoration: none;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', Helvetica, Arial, sans-serif;
        "
      >
        <div style="display: flex; align-items: center; gap: 5px; width: 100%; background: white" target="_blank">
          <div style="flex-basis: 50%">
            <img src="/EmailEngine_logo_vert.png" style="width: 130px" />
          </div>
          <div style="flex-basis: 50%">
            <div style="font-size: 13px; line-height: 1.5; text-align: left">Send and receive emails easily with Outlook and Gmail using OAuth2.</div>
          </div>
        </div>
      </a>
    </div>

    <ul class="topics">
             
<li
  data-nav-id="/about/"
  title="Nodemailer"
  class="dd-item
        
        
        
        "
>
  <a href="/about/">
    <b>1. </b>Nodemailer 
  </a>
   
  <ul>
               
<li data-nav-id="/about/migrate/" title="Migration" class="dd-item ">
  <a href="/about/migrate/">
    Migration 
  </a>
</li>
            
<li data-nav-id="/about/license/" title="License" class="dd-item ">
  <a href="/about/license/">
    License 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/usage/"
  title="Usage"
  class="dd-item
        
        
        
        "
>
  <a href="/usage/">
    <b>2. </b>Usage 
  </a>
   
  <ul>
               
<li data-nav-id="/usage/why-smtp/" title="SMTP? Say what?" class="dd-item ">
  <a href="/usage/why-smtp/">
    SMTP? Say what? 
  </a>
</li>
            
<li data-nav-id="/usage/using-gmail/" title="Using Gmail" class="dd-item ">
  <a href="/usage/using-gmail/">
    Using Gmail 
  </a>
</li>
            
<li data-nav-id="/usage/bulk-mail/" title="Delivering bulk mail" class="dd-item ">
  <a href="/usage/bulk-mail/">
    Delivering bulk mail 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/message/"
  title="Message configuration"
  class="dd-item
        
        
        
        "
>
  <a href="/message/">
    <b>3. </b>Message configuration 
  </a>
   
  <ul>
               
<li data-nav-id="/message/attachments/" title="Attachments" class="dd-item ">
  <a href="/message/attachments/">
    Attachments 
  </a>
</li>
            
<li data-nav-id="/message/alternatives/" title="Alternatives" class="dd-item ">
  <a href="/message/alternatives/">
    Alternatives 
  </a>
</li>
            
<li data-nav-id="/message/addresses/" title="Address object" class="dd-item ">
  <a href="/message/addresses/">
    Address object 
  </a>
</li>
            
<li data-nav-id="/message/calendar-events/" title="Calendar events" class="dd-item ">
  <a href="/message/calendar-events/">
    Calendar events 
  </a>
</li>
            
<li data-nav-id="/message/embedded-images/" title="Embedded images" class="dd-item ">
  <a href="/message/embedded-images/">
    Embedded images 
  </a>
</li>
            
<li data-nav-id="/message/list-headers/" title="List headers" class="dd-item ">
  <a href="/message/list-headers/">
    List headers 
  </a>
</li>
            
<li data-nav-id="/message/custom-headers/" title="Custom headers" class="dd-item ">
  <a href="/message/custom-headers/">
    Custom headers 
  </a>
</li>
            
<li data-nav-id="/message/custom-source/" title="Custom source" class="dd-item ">
  <a href="/message/custom-source/">
    Custom source 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/smtp/"
  title="SMTP transport"
  class="dd-item
        parent
        
        
        "
>
  <a href="/smtp/">
    <b>4. </b>SMTP transport 
  </a>
   
  <ul>
               
<li data-nav-id="/smtp/envelope/" title="SMTP envelope" class="dd-item ">
  <a href="/smtp/envelope/">
    SMTP envelope 
  </a>
</li>
            
<li data-nav-id="/smtp/pooled/" title="Pooled SMTP" class="dd-item ">
  <a href="/smtp/pooled/">
    Pooled SMTP 
  </a>
</li>
            
<li data-nav-id="/smtp/testing/" title="Testing SMTP" class="dd-item ">
  <a href="/smtp/testing/">
    Testing SMTP 
  </a>
</li>
            
<li data-nav-id="/smtp/oauth2/" title="OAuth2" class="dd-item active">
  <a href="/smtp/oauth2/">
    OAuth2 
  </a>
</li>
            
<li data-nav-id="/smtp/customauth/" title="Custom authentication" class="dd-item ">
  <a href="/smtp/customauth/">
    Custom authentication 
  </a>
</li>
            
<li data-nav-id="/smtp/proxies/" title="Proxy support" class="dd-item ">
  <a href="/smtp/proxies/">
    Proxy support 
  </a>
</li>
            
<li data-nav-id="/smtp/dsn/" title="Delivery status notifications" class="dd-item ">
  <a href="/smtp/dsn/">
    Delivery status notifications 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/transports/"
  title="Other transports"
  class="dd-item
        
        
        
        "
>
  <a href="/transports/">
    <b>5. </b>Other transports 
  </a>
   
  <ul>
               
<li data-nav-id="/transports/sendmail/" title="Sendmail transport" class="dd-item ">
  <a href="/transports/sendmail/">
    Sendmail transport 
  </a>
</li>
            
<li data-nav-id="/transports/ses/" title="SES transport" class="dd-item ">
  <a href="/transports/ses/">
    SES transport 
  </a>
</li>
            
<li data-nav-id="/transports/stream/" title="Stream transport" class="dd-item ">
  <a href="/transports/stream/">
    Stream transport 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/plugins/"
  title="Plugins"
  class="dd-item
        
        
        
        "
>
  <a href="/plugins/">
    <b>6. </b>Plugins 
  </a>
   
  <ul>
               
<li data-nav-id="/plugins/create/" title="Create plugins" class="dd-item ">
  <a href="/plugins/create/">
    Create plugins 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/dkim/"
  title="DKIM"
  class="dd-item
        
        
        
        "
>
  <a href="/dkim/">
    <b>7. </b>DKIM 
  </a>
   
</li>
         
<li
  data-nav-id="/extras/"
  title="Extra modules"
  class="dd-item
        
        
        
        "
>
  <a href="/extras/">
    <b>8. </b>Extra modules 
  </a>
   
  <ul>
               
<li data-nav-id="/extras/smtp-server/" title="SMTP Server" class="dd-item ">
  <a href="/extras/smtp-server/">
    SMTP Server 
  </a>
</li>
            
<li data-nav-id="/extras/smtp-connection/" title="SMTP Connection" class="dd-item ">
  <a href="/extras/smtp-connection/">
    SMTP Connection 
  </a>
</li>
            
<li data-nav-id="/extras/mailparser/" title="Mailparser" class="dd-item ">
  <a href="/extras/mailparser/">
    Mailparser 
  </a>
</li>
            
<li data-nav-id="/extras/mailcomposer/" title="Mailcomposer" class="dd-item ">
  <a href="/extras/mailcomposer/">
    Mailcomposer 
  </a>
</li>
            
<li data-nav-id="/extras/daemons/" title="Node.js daemons" class="dd-item ">
  <a href="/extras/daemons/">
    Node.js daemons 
  </a>
</li>
      
  </ul>
  
</li>
         
<li
  data-nav-id="/app/"
  title="NodemailerApp"
  class="dd-item
        
        
        
        "
>
  <a href="/app/">
    <b>9. </b>NodemailerApp 
  </a>
   
</li>
    
    </ul>

      
    <section id="footer"><div style="text-align: center; margin-bottom:10px;">
    <form
        action="https://www.paypal.com/cgi-bin/webscr"
        method="post"
        target="_top"
    >
        <input type="hidden" name="cmd" value="_s-xclick" />
        <input type="hidden" name="hosted_button_id" value="DB26KWR2BQX5W" />
        <input
            type="image"
            src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif"
            border="0"
            name="submit"
            alt="PayPal - The safer, easier way to pay online!"
            style="display: inline"
        />
        <img
            alt=""
            border="0"
            src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif"
            width="1"
            height="1"
        />
    </form>
</div>
</section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Nodemailer</a> > <a href='/smtp/'>SMTP transport</a> > OAuth2
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#oauth-3lo">3-legged OAuth2 authentication</a></li>
        <li><a href="#oauth-2lo">2LO authentication (service accounts)</a></li>
        <li><a href="#custom-handling">Using custom token handling</a></li>
        <li><a href="#update-notification">Token update notifications</a></li>
        <li><a href="#examples">Examples</a></li>
        <li><a href="#troubleshooting">Troubleshooting</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>OAuth2</h1>
          

        


<p>OAuth2 allows your application to store and use authentication tokens instead of actual login credentials. This is great for security as tokens or valid only for specific actions and can be easily revoked thus, once stolen, can&rsquo;t to as much harm as actual account credentials. OAuth2 authentication in Nodemailer is mostly used with Gmail and G Suite (<em>née</em> Google Apps) even though there are other providers that support it as well.</p>
<p>Access Tokens needed for OAuth2 authentication are short lived so these need to be regenerated from time to time. Nodemailer is able to use both <a href="https://developers.google.com/identity/protocols/OAuth2">3LO</a> and <a href="https://developers.google.com/api-client-library/php/auth/service-accounts">2LO</a> to automatically regenerate the tokens but you can also handle all token specific yourself.</p>
<ol>
<li><a href="#oauth-3lo">Normal OAuth2 authentication</a></li>
<li><a href="#oauth-2lo">Authenticating using Service Accounts</a></li>
<li><a href="#custom-handling">Using custom token handling</a></li>
<li><a href="#update-notification">Token update notifications</a></li>
<li><a href="#examples">Examples</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
</ol>
<div class="notices tip" >
<p>Managing OAuth2 app credentials is hard, so you could let <a href="https://emailengine.app/?utm_source=nodemailer&amp;utm_campaign=nodemailer&amp;utm_medium=tip-link">EmailEngine</a> handle these for you. Once you have registered an email account with EmailEngine, you can use EmailEngine as an SMTP gateway without any authentication. EmailEngine will handle everything regarding the actual credentials itself. Read more <a href="https://emailengine.app/sending-emails?utm_source=nodemailer&amp;utm_campaign=nodemailer&amp;utm_medium=tip-link">here</a>.</p>
</div>
<h3 id="oauth-3lo">3-legged OAuth2 authentication</h3>
<p>This is the &ldquo;normal&rdquo; way of obtaining access tokens. Your application requests permissions from the client and gets a refresh token in return that can be used to generate new access tokens.</p>
<p>You can find an example of how to generate required tokens from <a href="https://docs.emailengine.app/setting-up-gmail-oauth2-for-imap-api/?utm_source=nodemailer&amp;utm_campaign=nodemailer&amp;utm_medium=oauth-link">EmailEngine&rsquo;s documentation</a>.</p>
<ul>
<li>
<p><strong>auth</strong> – is the authentication object</p>
<ul>
<li><strong>type</strong> – indicates authentication type, set it to <em>&lsquo;OAuth2&rsquo;</em></li>
<li><strong>user</strong> – user email address (required)</li>
<li><strong>clientId</strong> – is the registered client id of the application</li>
<li><strong>clientSecret</strong> – is the registered client secret of the application</li>
<li><strong>refreshToken</strong> – is an optional refresh token. If it is provided then Nodemailer tries to generate a new access token if existing one expires or fails</li>
<li><strong>accessToken</strong> – is the access token for the user. Required only if <em>refreshToken</em> is not available and there is no token refresh callback specified</li>
<li><strong>expires</strong> – is an optional expiration time for the current <em>accessToken</em></li>
<li><strong>accessUrl</strong> – is an optional HTTP endpoint for requesting new access tokens. This value defaults to Gmail</li>
</ul>
</li>
</ul>
<p>Normal SMTP transport (ie. not the pooled version) has a convenience method of using separate authentication for every message. This allows you to set up a transport with just <em>clientId</em> and <em>clientSecret</em> values and provide <em>accessToken</em> and <em>refreshToken</em> with the message options. See <a href="#example-5">example 5</a>.</p>
<h3 id="oauth-2lo">2LO authentication (service accounts)</h3>
<p>Nodemailer also allows you to use <a href="https://developers.google.com/identity/protocols/OAuth2ServiceAccount">service accounts</a> to generate access tokens. In this case the required <code>auth</code> options are a bit different from 3LO auth. You can find an example of how to generate service tokens from <a href="https://docs.emailengine.app/gmail-oauth-service-accounts/?utm_source=nodemailer&amp;utm_campaign=nodemailer&amp;utm_medium=oauth-link">EmailEngine&rsquo;s documentation</a>.</p>
<ul>
<li>
<p><strong>auth</strong> – is the authentication object</p>
<ul>
<li><strong>type</strong> – indicates authentication type, set it to <em>&lsquo;OAuth2&rsquo;</em></li>
<li><strong>user</strong> – user email address you want to send mail as (required)</li>
<li><strong>serviceClient</strong> – service client id (required), you can find it from the &ldquo;client_id&rdquo; field in the service key file</li>
<li><strong>privateKey</strong> – is the private key contents, you can find it from the &ldquo;private_key&rdquo; field in the service key file</li>
</ul>
</li>
</ul>
<h3 id="custom-handling">Using custom token handling</h3>
<p>If you do not want Nodemailer to create new access tokens then you can provide a custom token generation callback that is called every time a new token is needed for an user.</p>
<p>The registered function gets the following arguments:</p>
<ul>
<li><strong>user</strong> – is the user email address</li>
<li><strong>renew</strong> – if <em>true</em> then previous access token either expired or it was not accepted by the SMTP server, in this case you should generate a new value</li>
<li><strong>callback</strong> with arguments <em>(err, accessToken)</em> – is the callback function to run once you have generated a new access token</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">transporter</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#34;oauth2_provision_cb&#34;</span>, (<span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">renew</span>, <span style="color:#a6e22e">callback</span>) =&gt; {
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">accessToken</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">userTokens</span>[<span style="color:#a6e22e">user</span>];
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">accessToken</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Unknown user&#34;</span>));
  } <span style="color:#66d9ef">else</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, <span style="color:#a6e22e">accessToken</span>);
  }
});
</code></pre></div><h3 id="update-notification">Token update notifications</h3>
<p>If you use <em>refreshToken</em> or service keys to generate new tokens from Nodemailer when <em>accessToken</em> is not present or expired then you can listen for the token updates by registering a &lsquo;token&rsquo; event handler for the transporter object.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">transporter</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;token&#34;</span>, (<span style="color:#a6e22e">token</span>) =&gt; {
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;A new access token was generated&#34;</span>);
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;User: %s&#34;</span>, <span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">user</span>);
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Access Token: %s&#34;</span>, <span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">accessToken</span>);
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Expires: %s&#34;</span>, <span style="color:#66d9ef">new</span> Date(<span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">expires</span>));
});
</code></pre></div><h3 id="examples">Examples</h3>
<h4 id="example-1">1. Authenticate using existing token</h4>
<p>Use an existing Access Token. If the token is not accepted then message is not sent as there is no way to generate a new token.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">transporter</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">nodemailer</span>.<span style="color:#a6e22e">createTransport</span>({
  <span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;smtp.gmail.com&#34;</span>,
  <span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">465</span>,
  <span style="color:#a6e22e">secure</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
  <span style="color:#a6e22e">auth</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OAuth2&#34;</span>,
    <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;user@example.com&#34;</span>,
    <span style="color:#a6e22e">accessToken</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ya29.Xx_XX0xxxxx-xX0X0XxXXxXxXXXxX0x&#34;</span>,
  },
});
</code></pre></div><h4 id="example-2">2. Custom handler</h4>
<p>This example requests a new <em>accessToken</em> value from a custom OAuth2 handler. Nodemailer does not attempt to generate the token by itself.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">transporter</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">nodemailer</span>.<span style="color:#a6e22e">createTransport</span>({
  <span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;smtp.gmail.com&#34;</span>,
  <span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">465</span>,
  <span style="color:#a6e22e">secure</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
  <span style="color:#a6e22e">auth</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OAuth2&#34;</span>,
    <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;user@example.com&#34;</span>,
  },
});

<span style="color:#a6e22e">transporter</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#34;oauth2_provision_cb&#34;</span>, (<span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">renew</span>, <span style="color:#a6e22e">callback</span>) =&gt; {
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">accessToken</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">userTokens</span>[<span style="color:#a6e22e">user</span>];
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">accessToken</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Unknown user&#34;</span>));
  } <span style="color:#66d9ef">else</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, <span style="color:#a6e22e">accessToken</span>);
  }
});
</code></pre></div><h4 id="example-3">3. Set up 3LO authentication</h4>
<p>This example uses an existing Access Token. If the token is not accepted or current time is past the <em>expires</em> value, then <em>refreshToken</em> is used to automatically generate a new <em>accessToken</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">transporter</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">nodemailer</span>.<span style="color:#a6e22e">createTransport</span>({
  <span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;smtp.gmail.com&#34;</span>,
  <span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">465</span>,
  <span style="color:#a6e22e">secure</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
  <span style="color:#a6e22e">auth</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OAuth2&#34;</span>,
    <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;user@example.com&#34;</span>,
    <span style="color:#a6e22e">clientId</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;000000000000-xxx0.apps.googleusercontent.com&#34;</span>,
    <span style="color:#a6e22e">clientSecret</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;XxxxxXXxX0xxxxxxxx0XXxX0&#34;</span>,
    <span style="color:#a6e22e">refreshToken</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;1/XXxXxsss-xxxXXXXXxXxx0XXXxxXXx0x00xxx&#34;</span>,
    <span style="color:#a6e22e">accessToken</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ya29.Xx_XX0xxxxx-xX0X0XxXXxXxXXXxX0x&#34;</span>,
    <span style="color:#a6e22e">expires</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1484314697598</span>,
  },
});
</code></pre></div><h4 id="example-4">4. Set up 2LO authentication</h4>
<p>This example uses an existing Access Token. If the token is not accepted or current time is past the <em>expires</em> value, then a new <em>accessToken</em> value is generated using provided service account.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">transporter</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">nodemailer</span>.<span style="color:#a6e22e">createTransport</span>({
  <span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;smtp.gmail.com&#34;</span>,
  <span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">465</span>,
  <span style="color:#a6e22e">secure</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
  <span style="color:#a6e22e">auth</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OAuth2&#34;</span>,
    <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;user@example.com&#34;</span>,
    <span style="color:#a6e22e">serviceClient</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;113600000000000000000&#34;</span>,
    <span style="color:#a6e22e">privateKey</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBg...&#34;</span>,
    <span style="color:#a6e22e">accessToken</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ya29.Xx_XX0xxxxx-xX0X0XxXXxXxXXXxX0x&#34;</span>,
    <span style="color:#a6e22e">expires</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1484314697598</span>,
  },
});
</code></pre></div><h4 id="example-5">5. Provide authentication details with message options</h4>
<p>This example demonstrates how to authenticate every message separately. This is mostly useful if you provide an email application that sends mail for multiple users. Instead of creating a new transporter for every message, create it just once and provide dynamic details with the message options.</p>
<div class="notices info" >
Per-message specific authentication does not work in pooled mode
</div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">transporter</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">nodemailer</span>.<span style="color:#a6e22e">createTransport</span>({
  <span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;smtp.gmail.com&#34;</span>,
  <span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">465</span>,
  <span style="color:#a6e22e">secure</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
  <span style="color:#a6e22e">auth</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OAuth2&#34;</span>,
    <span style="color:#a6e22e">clientId</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;000000000000-xxx.apps.googleusercontent.com&#34;</span>,
    <span style="color:#a6e22e">clientSecret</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;XxxxxXXxX0xxxxxxxx0XXxX0&#34;</span>,
  },
});

<span style="color:#a6e22e">transporter</span>.<span style="color:#a6e22e">sendMail</span>({
  <span style="color:#a6e22e">from</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;sender@example.com&#34;</span>,
  <span style="color:#a6e22e">to</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;recipient@example.com&#34;</span>,
  <span style="color:#a6e22e">subject</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Message&#34;</span>,
  <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;I hope this message gets through!&#34;</span>,
  <span style="color:#a6e22e">auth</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;user@example.com&#34;</span>,
    <span style="color:#a6e22e">refreshToken</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;1/XXxXxsss-xxxXXXXXxXxx0XXXxxXXx0x00xxx&#34;</span>,
    <span style="color:#a6e22e">accessToken</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ya29.Xx_XX0xxxxx-xX0X0XxXXxXxXXXxX0x&#34;</span>,
    <span style="color:#a6e22e">expires</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1484314697598</span>,
  },
});
</code></pre></div><p>Or alternatively you can do the same with your own OAuth2 handler.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">transporter</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">nodemailer</span>.<span style="color:#a6e22e">createTransport</span>({
  <span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;smtp.gmail.com&#34;</span>,
  <span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">465</span>,
  <span style="color:#a6e22e">secure</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
  <span style="color:#a6e22e">auth</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OAuth2&#34;</span>,
  },
});

<span style="color:#a6e22e">transporter</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#34;oauth2_provision_cb&#34;</span>, (<span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">renew</span>, <span style="color:#a6e22e">callback</span>) =&gt; {
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">accessToken</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">userTokens</span>[<span style="color:#a6e22e">user</span>];
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">accessToken</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Unknown user&#34;</span>));
  } <span style="color:#66d9ef">else</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">callback</span>(<span style="color:#66d9ef">null</span>, <span style="color:#a6e22e">accessToken</span>);
  }
});

<span style="color:#a6e22e">transporter</span>.<span style="color:#a6e22e">sendMail</span>({
  <span style="color:#a6e22e">from</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;sender@example.com&#34;</span>,
  <span style="color:#a6e22e">to</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;recipient@example.com&#34;</span>,
  <span style="color:#a6e22e">subject</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Message&#34;</span>,
  <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;I hope this message gets through!&#34;</span>,
  <span style="color:#a6e22e">auth</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;user@example.com&#34;</span>,
  },
});
</code></pre></div><h3 id="troubleshooting">Troubleshooting</h3>
<ul>
<li>The correct OAuth2 scope for Gmail SMTP is <code>https://mail.google.com/</code>, make sure your client has this scope set when requesting permissions for an user</li>
<li>Make sure that Gmail API access is enabled for your Client ID. To do this, search for the Gmail API in <a href="https://console.developers.google.com">Google API Manager</a> and click on &ldquo;enable&rdquo;</li>
</ul>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/smtp/testing/" title="Testing SMTP"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/smtp/customauth/" title="Custom authentication" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1681891445"></script>
    <script src="/js/perfect-scrollbar.min.js?1681891445"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1681891445"></script>
    <script src="/js/jquery.sticky.js?1681891445"></script>
    <script src="/js/featherlight.min.js?1681891445"></script>
    <script src="/js/html5shiv-printshiv.min.js?1681891445"></script>
    <script src="/js/highlight.pack.js?1681891445"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1681891445"></script>
    <script src="/js/learn.js?1681891445"></script>
    <script src="/js/hugo-learn.js?1681891445"></script>

    <link href="/mermaid/mermaid.css?1681891445" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1681891445"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

